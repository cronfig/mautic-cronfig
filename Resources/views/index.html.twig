{% extends '@MauticCore/Default/content.html.twig' %}
{% block mauticContent %}cronfig{% endblock %}
{% block headerTitle %}{{ 'cronfig.title'|trans }}{% endblock %}
{% block content %}
    {{ includeStylesheet('plugins/CronfigBundle/Assets/css/cronfig.css') }}

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}
    <!--[if lt IE 8]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div id="cronfig-wrapper" class="col-md-12">
        <img
            class="loading"
            src="{{ getAssetUrl('plugins/CronfigBundle/Assets/img/ring.svg') }}"
            onerror="this.src='{{ getAssetUrl('plugins/CronfigBundle/Assets/img/ring.gif') }}'; this.onerror=null;"
            alt="loading..." />
    </div>
    <script id="cronfig-config" type="text/javascript">
        document.cronfigConfig = {
            platform: 'mautic',
            tasks: {{ commands|json_encode|raw }},
            email: '{{ email }}',
            apiKey: '{{ apiKey }}',
            rememberApiKey: function(apiKey) {
                Mautic.ajaxActionRequest('plugin:cronfig:saveApiKey', 'apiKey=' + apiKey, function(response) {
                    if (typeof response.secret_key !== 'undefined') {
                        for (var i = 0; i < document.cronfigConfig.tasks.length; i++) {
                            if (document.cronfigConfig.tasks[i].url.indexOf('?secret_key=') === -1) {
                                document.cronfigConfig.tasks[i].url += '?secret_key=' + response.secret_key;
                            }
                        }
                    }
                }, true);
            }
        }
    </script>
    <script type="text/javascript" src="https://cdn.cronfig.io/cronfig.js"></script>
{% endblock %}
